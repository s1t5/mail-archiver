@inject Microsoft.Extensions.Localization.IStringLocalizer<MailArchiver.SharedResource> Localizer
@{ 
    ViewData["Title"] = Localizer["ChangePasswordTitle"]; 
    var mustChange = ViewBag.MustChangePassword as bool? ?? false;
}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@Localizer["ChangePasswordTitle"]</h1>
        @if (!mustChange)
        {
            <a asp-controller="Home" asp-action="Index" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> @Localizer["BackToDashboard"]</a>
        }
    </div>
    
    @if (mustChange)
    {
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> @Localizer["PasswordChangeRequired"]</h4>
            <p>@Localizer["PasswordChangeRequiredMessage"]</p>
            <hr>
            <p class="mb-0">@Localizer["PasswordChangeRequiredInfo"]</p>
        </div>
    }
    
    <div class="card">
        <div class="card-body">
            <form asp-action="ChangePassword" method="post" id="changePasswordForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                
                <div class="mb-3">
                    <label for="username" class="form-label">@Localizer["Username"]</label>
                    <input type="text" class="form-control" id="username" value="@ViewBag.Username" disabled />
                </div>
                
                @if (ViewBag.UserHasPassword)
                {
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">@Localizer["CurrentPassword"]</label>
                        <input type="password" name="currentPassword" class="form-control" id="currentPassword" required />
                        <span class="text-danger field-validation-valid" data-valmsg-for="currentPassword" data-valmsg-replace="true"></span>
                    </div>
                }
                
                <div class="mb-3">
                    <label for="newPassword" class="form-label">@Localizer["NewPassword"]</label>
                    <input type="password" name="newPassword" class="form-control" id="newPassword" required />
                    <span class="text-danger field-validation-valid" data-valmsg-for="newPassword" data-valmsg-replace="true"></span>
                    
                    <!-- Password Requirements -->
                    <div class="mt-2">
                        <small class="text-muted">@Localizer["PasswordRequirements"]:</small>
                        <ul class="small text-muted mt-1" id="passwordRequirements">
                            <li id="req-length" class="requirement-unchecked"><i class="bi bi-x-circle"></i> @Localizer["PasswordMinLength"]</li>
                            <li id="req-uppercase" class="requirement-unchecked"><i class="bi bi-x-circle"></i> @Localizer["PasswordRequiresUppercase"]</li>
                            <li id="req-lowercase" class="requirement-unchecked"><i class="bi bi-x-circle"></i> @Localizer["PasswordRequiresLowercase"]</li>
                            <li id="req-number" class="requirement-unchecked"><i class="bi bi-x-circle"></i> @Localizer["PasswordRequiresNumber"]</li>
                            <li id="req-special" class="requirement-unchecked"><i class="bi bi-x-circle"></i> @Localizer["PasswordRequiresSpecialChar"]</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="confirmNewPassword" class="form-label">@Localizer["ConfirmNewPassword"]</label>
                    <input type="password" name="confirmNewPassword" class="form-control" id="confirmNewPassword" required />
                    <span class="text-danger field-validation-valid" data-valmsg-for="confirmNewPassword" data-valmsg-replace="true"></span>
                </div>
                
                <div class="d-flex justify-content-between">
                    @if (!mustChange)
                    {
                        <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">@Localizer["Cancel"]</a>
                    }
                    else
                    {
                        <span></span>
                    }
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> @Localizer["ChangePasswordTitle"]</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            var mustChangePassword = @Json.Serialize(mustChange);
            
            // Password validation UI updates
            $('#newPassword').on('input', function() {
                var password = $(this).val();
                
                // Check length
                updateRequirement('req-length', password.length >= 10);
                
                // Check uppercase
                updateRequirement('req-uppercase', /[A-Z]/.test(password));
                
                // Check lowercase
                updateRequirement('req-lowercase', /[a-z]/.test(password));
                
                // Check number
                updateRequirement('req-number', /[0-9]/.test(password));
                
                // Check special character
                updateRequirement('req-special', /[^A-Za-z0-9]/.test(password));
            });
            
            function updateRequirement(elementId, isValid) {
                var element = $('#' + elementId);
                if (isValid) {
                    element.removeClass('requirement-unchecked text-muted').addClass('requirement-checked text-success');
                    element.find('i').removeClass('bi-x-circle').addClass('bi-check-circle');
                } else {
                    element.removeClass('requirement-checked text-success').addClass('requirement-unchecked text-muted');
                    element.find('i').removeClass('bi-check-circle').addClass('bi-x-circle');
                }
            }
            
            // Prevent leaving page if password change is required
            if (mustChangePassword) {
                // Prevent browser back button
                window.history.pushState(null, '', window.location.href);
                window.onpopstate = function() {
                    window.history.pushState(null, '', window.location.href);
                    alert('@Localizer["CannotLeavePasswordChange"]');
                };
                
                // Warn before leaving page
                window.addEventListener('beforeunload', function(e) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                });
                
                // Remove warning after successful form submission
                $('#changePasswordForm').on('submit', function() {
                    window.onbeforeunload = null;
                });
            }
        });
    </script>
    <style>
        .requirement-checked {
            color: #28a745 !important;
        }
        .requirement-unchecked {
            color: #6c757d !important;
        }
    </style>
}
